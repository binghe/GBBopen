<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!-- XML file produced from file: tutorial.tex
     using Hyperlatex v 2.9-in-waiting-rk (c) Otfried Cheong -->
<head>
<title>GBBopen 1.0 Tutorial -- Deleting Instances</title>
</p>
<link rel="SHORTCUT ICON" href="favicon.ico"><link rel=stylesheet
        href="gbbopen.css" type="text/css" />
</head>
<body>
<table width="100%" cellpadding="0" cellspacing="2"><tr>
<td bgcolor="#99ccff"><a href="tutorial-creating-a-space-instance.html"><img border="0" alt="Creating a Space Instance" src="previous.png"/></a></td><td bgcolor="#99ccff"><a href="tutorial_0.html"><img border="0" alt="Top" src="up.png"/></a></td><td bgcolor="#99ccff"><a href="tutorial-development-environment.html"><img border="0" alt="Enhancing Your Development Environment" src="next.png"/></a></td><td align="center" bgcolor="#99ccff" width="100%"><b>Deleting Instances</b></td><td bgcolor="#99ccff"><a target="_top" href="tutorial.html"><img border="0" alt="GoTo Top" src="top.png"/></a></td></tr></table>
<h1>Deleting Instances</h1>
<p>GBBopen retains created unit and space instances until they are explicitly
deleted.  This behavior is important to blackboard applications, where shared
information in the form of unit instances remains available until a decision
is made to remove them.
</p>
<p>In this exercise, we explore some implications of deleting unit and space
instances.
</p>
<p><hr color="99CCCC">
This exercise shows you how to:
</p>
<p><ul class="tight"><li>Delete a unit instance
<li>Create a space-instance hierarchy
<li>Delete a space instance
<li>Delete all unit and space instances from the blackboard repository
</ul>
</p>
<hr color="99CCCC">
<h2><a name="id1">Prerequisites</a></h2><p>
If you ended the Common Lisp session used in the last exercise, begin a new
session and evaluate the following forms:
<pre class="pretop">
<font color="#667f66">  cl-user&gt; <font color="#000000">(load "<var>&lt;install-dir&gt;</var>/startup.lisp")</font>
     ...
  cl-user&gt; <font color="#000000">(mini-module:compile-module :gbbopen-user :propagate :create-dirs)</font>
     ...
  cl-user&gt; <font color="#000000">(in-package :gbbopen-user)</font>
  #&lt;package GBBOPEN-USER&gt;
  gbbopen-user&gt; <font color="#000000">(define-unit-class location ()
                   (x y))</font>
  #&lt;standard-unit-class location&gt;
  gbbopen-user&gt; <font color="#000000">(defparameter ui (make-instance 'location :x 50 :y 60))</font>
  ui
  gbbopen-user&gt; <font color="#000000">(defparameter si (make-space-instance '(known-world)))</font>
  si
  gbbopen-user&gt; <font color="#000000">(add-instance-to-space-instance 
                   (make-instance 'location :x 80 :y 90)
                   si)</font>
  #&lt;location 2&gt;
  gbbopen-user&gt;</font>
</pre>
</p>
<h2><a name="id2">Step 1: Create a few more unit instances</a></h2><p>
Just to review, we created two <code>location</code> unit instances.  The unit
instance named <code>1</code> is no longer on the <code>known-world</code> space instance,
but it is still assigned to the global variable <code>ui</code>:
<a name="id3"></a><pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">ui</font>
  #&lt;location 1&gt; 
  gbbopen-user&gt;</font>
</pre>
The <code>location</code> unit instance named <code>2</code> is the only <code>location</code>
unit instance on the <code>known-world</code> space instance:
<a name="id4"></a><pre>
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(find-instances 'location '(known-world) :all)</font>
  (#&lt;location 2&gt;)
  gbbopen-user&gt;</font>
</pre>
</p>
<p>Now, let's create five more <code>location</code> unit instances.  Enter:
<a name="id5"></a><pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(dotimes (i 5) (make-instance 'location))</font>
  nil
  gbbopen-user&gt;</font>
</pre>
Note that we did not specify <code>x</code> and <code>y</code> slot values for these new
unit instances.  We will explore the implications of this shortly.
</p>
<h2><a name="id6">Step 2: Apply a function to all instances of a unit class</a></h2><p>
We did not assign the new <code>location</code> unit instances to global variables
or add them to the <code>known-world</code> space instance.  Can we still reference
them?  If we know the names of the new unit instances, we can use the
<b>find-instance-by-name</b> function that we learned earlier.  For example:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(find-instance-by-name 5 'location)</font>
  #&lt;location 5&gt;
  gbbopen-user&gt;</font>
</pre>
</p>
<p><a name="id7">It</a> is often useful to perform some action on all instances of a unit class.
GBBopen provides a <i>mapping function</i>, or &#8220;iterator,&#8221; that repeatedly
calls a function with each instance of a unit class as the argument to the
function.  For example:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(map-instances-of-class #'print 'location)</font>

  #&lt;location 6&gt; 
  #&lt;location 3&gt; 
  #&lt;location 7&gt; 
  #&lt;location 1&gt; 
  #&lt;location 2&gt; 
  #&lt;location 4&gt; 
  #&lt;location 5&gt; 
  nil
  gbbopen-user&gt;</font>
</pre>
displays each of our <code>location</code> unit instances.  Note that the exact
order that <code>location</code> unit instances are supplied to the <code>print</code>
function may differ from the above example in your Common Lisp implementation.
</p>
<p><a name="id8">Currently,</a> there is only one <code>location</code> unit instance on the
<code>known-world</code> space instance:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(find-instances 'location '(known-world) :all)</font>
  (#&lt;location 2&gt;)
  gbbopen-user&gt;</font>
</pre>
</p>
<p>Let's use <b>map-instances-of-class</b> to add all the <code>location</code> unit
instances to the <code>known-world</code>:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(map-instances-of-class 
                  #'(lambda (instance) 
                       (add-instance-to-space-instance instance si))
                 'location)</font>
  Warning: In add-instance-to-space-instance: #&lt;location 2&gt; is already on 
           space instance #&lt;standard-space-instance (known-world)&gt;.
  nil
  gbbopen-user&gt;</font>
</pre>
GBBopen warns us that the <code>location</code> <code>2</code> unit instance is already on
the <code>known-world</code> and adds all the other <code>location</code> instances.  We
can verify this by using <b>find-instances</b>:
<pre>
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(find-instances 'location '(known-world) :all)</font>
  (#&lt;location 7&gt; #&lt;location 6&gt; #&lt;location 5&gt; #&lt;location 4&gt; #&lt;location 3&gt;
   #&lt;location 2&gt; #&lt;location 1&gt;)
  gbbopen-user&gt;</font>
</pre>
</p>
<p><a name="id9">For</a> those who prefer a more iterative programming style, GBBopen provides a
<tt>dolist</tt>-style macro, <b>do-instances-of-class</b>, as an alternative
to <b>map-instances-of-class</b>.  So, to add all the <code>location</code> unit
instances to the <code>known-world</code>, we could have chosen to use the form:
<pre class="pretop">
<font color="#667f66">  (do-instances-of-class (instance 'location)
     (add-instance-to-space-instance instance si))</font>
</pre>
instead of the <b>map-instances-of-class</b> version.  As with things
stylistic, the choice is yours.
</p>
<h2><a name="id10">Step 3: Delete a unit instance</a></h2><p>
Let's delete the first <code>location</code> unit instance that we created:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(delete-instance ui)</font>
  #&lt;location 1 [Deleted]&gt;
  gbbopen-user&gt;</font>
</pre>
Note that the displayed representation of the unit instance now includes
<code>[Deleted]</code> to let us know that the unit instance has been deleted.
</p>
<p><a name="id11">We</a> can no longer find the deleted unit instance by its name:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(find-instance-by-name 1 'location)</font>
  nil
  gbbopen-user&gt;</font>
</pre>
and it is no longer included in a <b>map-instances-of-class</b> iteration:
<pre>
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(map-instances-of-class #'print 'location)</font>

  #&lt;location 6&gt; 
  #&lt;location 3&gt; 
  #&lt;location 7&gt; 
  #&lt;location 2&gt; 
  #&lt;location 4&gt; 
  #&lt;location 5&gt; 
  nil
  gbbopen-user&gt;</font>
</pre>
and it is no longer on the <code>known-world</code> space instance:
<pre>
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(find-instances 'location '(known-world) :all)</font>
  (#&lt;location 7&gt; #&lt;location 6&gt; #&lt;location 5&gt; #&lt;location 4&gt; #&lt;location 3&gt;
   #&lt;location 2&gt;)
  gbbopen-user&gt;</font>
</pre>
</p>
<p><a name="id12">However,</a> the deleted <code>location</code> unit instance is still assigned to the
<code>ui</code> global variable:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">ui</font>
  #&lt;location 1 [Deleted]&gt;
  gbbopen-user&gt;</font>
</pre>
and that can lead to problems.  Let's try to place the deleted <code>location</code>
unit instance on the <code>known-world</code> space instance:
<pre>
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(add-instance-to-space-instance ui si)</font>
  Error: add-instance-to-space-instance attempted with a deleted instance:
         #&lt;location 1 [Deleted]&gt;
  gbbopen-user&gt;&gt; <font color="#000000">:a</font>
  gbbopen-user&gt;</font>
</pre>
</p>
<p>Many of GBBopen's operations signal an error if they are given a deleted unit
instance.  This is not true of all operations, however:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(x-of ui)</font>
  50
  gbbopen-user&gt;</font>
</pre>
</p>
<p><a name="id13">Typically,</a> blackboard applications obtain unit instances from the blackboard
repository rather than maintaining references to them in variables.  This
limits the possibility of obtaining a deleted unit instance and performing
GBBopen operations on it.  Regular CLOS operations on a deleted unit instance,
such as reading and writing slot values, function normally.  The deletion
status of a unit instance can be determined using the
<b>instance-deleted-p</b> predicate:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(instance-deleted-p ui)</font>
  t
  gbbopen-user&gt;</font>
</pre>
</p>
<h2><a name="id14">Step 4: Create a simple space-instance hierarchy</a></h2><p>
In the last exercise, we noted that space instances can be organized in
hierarchical structures.  To illustrate this, let's create a few more space
instances:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(make-space-instance '(known-world my-town))</font>
  #&lt;standard-space-instance (known-world my-town)&gt;
  gbbopen-user&gt; <font color="#000000">(make-space-instance '(known-world my-town east-side))</font>
  #&lt;standard-space-instance (known-world my-town east-side)&gt;
  gbbopen-user&gt; <font color="#000000">(make-space-instance '(known-world my-town west-side))</font>
  #&lt;standard-space-instance (known-world my-town west-side)&gt;
  gbbopen-user&gt;</font>
</pre>
</p>
<p><a name="id15">Recall</a> that the <var>space-instance-path</var> argument to
<b>make-space-instance</b> is the complete list of space-instance names,
starting with the name of the most distant indirect parent.  So, the
<code>my-town</code> space instance has the <code>known-world</code> as it's parent and
the <code>east-side</code> and <code>west-side</code> as children.  We can use
<b>describe-blackboard-repository</b> to see this organization:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(describe-blackboard-repository)</font>

  Space Instance                Contents
  --------------                --------
  known-world                   6 instances (6 location)
     my-town                    Empty
        east-side               Empty
        west-side               Empty

  Unit Class                    Instances
  ----------                    ---------
  location                              6
  standard-space-instance               4
                                ---------
                                       10 instances
  gbbopen-user&gt;</font>
</pre>
</p>
<p><a name="id16">Observe</a> from the above description that child space instances that we created
are not placed on their parent.  Unlike the directories in a file system in
the analogy that we presented in the last exercise, in GBBopen a
space-instance hierarchy is orthogonal to containment.  In fact, space
instances are actually unit instances (of the class
<b>standard-space-instance</b>, by default) and a space instance can be
placed on other space instances&mdash;or even on itself.  Typical blackboard
applications do not involve using space instances as unit instances, but this
property of space instances is very powerful when it is needed.
</p>
<p><a name="id17">The</a> functions <b>parent-of</b> and <b>children-of</b> are provided to
traverse the space-instance hierarchy.  For example:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(children-of 
                  (find-space-instance-by-path '(known-world my-town)))</font>
  (#&lt;standard-space-instance (known-world my-town west-side)&gt;
   #&lt;standard-space-instance (known-world my-town east-side)&gt;)
  gbbopen-user&gt;</font>
</pre>
</p>
<h2><a name="id18">Step 5: Add a unit instance to multiple space instances</a></h2><p>
Now, let's add <code>location</code> <code>2</code> to the <code>my-town</code> and 
<code>east-side</code> space instances:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(let ((location-2 (find-instance-by-name 2 'location)))
                 (add-instance-to-space-instance location-2 '(known-world my-town))
                 (add-instance-to-space-instance location-2 '(known-world my-town east-side)))</font>
  #&lt;location 2&gt;
  gbbopen-user&gt;</font>
</pre>
<a name="id19">As</a> we expect, <code>location</code> <code>2</code> is now on three space instances:
<pre>
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(describe-instance (find-instance-by-name 2 'location))</font>
  Location #&lt;location 2&gt;
    Instance name: 2
    Space instances: ((known-world my-town east-side)
                      (known-world my-town)
                      (known-world))
    Dimensional values: None
    Non-link slots:
      x:  80
      y:  90
    Link slots: None
  gbbopen-user&gt;</font>
</pre>
and the description of the blackboard repository is:
<pre>
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(describe-blackboard-repository)</font>

  Space Instance                Contents
  --------------                --------
  known-world                   6 instances (6 location)
     my-town                    1 instance (1 location)
        east-side               1 instance (1 location)
        west-side               Empty

  Unit Class                    Instances
  ----------                    ---------
  location                              6
  standard-space-instance               4
                                ---------
                                       10 instances
  gbbopen-user&gt;</font>
</pre>
</p>
<p>Placing a unit instance on multiple space instances is useful when each space
instance represents a different view of unit instances.  In this case,
<code>location</code> <code>2</code> is in the <code>known-world</code>, in <code>my-town</code>, and
on the <code>east-side</code>:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(find-instances 'location '(known-world my-town) :all)</font>
  (#&lt;location 2&gt;)
  gbbopen-user&gt; <font color="#000000">(find-instances 'location '(known-world my-town east-side) :all)</font>
  (#&lt;location 2&gt;)
  gbbopen-user&gt;</font>
</pre>
</p>
<h2><a name="id20">Step 6: Delete a space instance</a></h2><p>
Now let's delete some of what we just created.  Let's delete the
<code>my-town</code> space instance:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(delete-space-instance '(known-world my-town))</font>
  #&lt;standard-space-instance (known-world my-town) [Deleted]&gt;
  gbbopen-user&gt;</font>
</pre>
<a name="id21">and</a> describe the blackboard repository:
<pre>
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(describe-blackboard-repository)</font>

  Space Instance                Contents
  --------------                --------
  known-world                   6 instances (6 location)

  Unit Class                    Instances
  ----------                    ---------
  location                              6
  standard-space-instance               1
                                ---------
                                        7 instances
  gbbopen-user&gt;</font>
</pre>
Notice that GBBopen has also deleted all the child space instances of
<code>my-town</code>: both <code>east-side</code> and <code>west-side</code> were also deleted.
So, just as with our file-system directory analogy, space-instance deletion is
recursive over children and should be performed with caution.  
</p>
<p><a name="id22">Also</a> note that deleting space instances did not delete any of the unit
instances that were stored on them.  If we want to delete a space instance
<i>and</i> all the unit instances that are stored on it, we must
explicitly delete the unit instances before deleting the space instance.
For example, we could do:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; (map-instances-on-space-instances #'delete-instance 
                  'location '(known-world my-town))
  nil
  gbbopen-user&gt;</font>
</pre>
to delete the unit instances in <code>my-town</code>.  However, we must keep in mind
that a unit instance can reside on multiple space instances; so deleting a
unit instance that is on other space instances might not be the desired
action.
</p>
<p><a name="id23">As</a> is the case with <b>map-instances-of-class</b>, GBBopen provides a
<b>do-instances-on-space-instances</b> macro as an alternative to
<b>map-instances-on-space-instances</b>.  So we could have chosen to use the
form:
<pre class="pretop">
<font color="#667f66">  (do-instances-on-space-instances (instance 'location '(known-world my-town))
    (delete-instance instance))</font>
</pre>
to explicitly delete the <code>location</code> unit instances in <code>my-town</code>.
</p>
<h2><a name="id24">Step 7: Delete the Blackboard Repository</a></h2><p>
If we really want to get rid of all our unit and space instances, we can use
the <b>delete-blackboard-repository</b> function:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(delete-blackboard-repository)</font>
  t
  gbbopen-user&gt; <font color="#000000">(describe-blackboard-repository)</font>
  There are no space instances in the blackboard repository.
  gbbopen-user&gt; <font color="#000000">(map-instances-of-class #'print location)</font>
  nil
  gbbopen-user&gt;</font>
</pre>
</p>
<p><a name="id25"></a><b>delete-blackboard-repository</b> has deleted every space and unit
instance, but it has not eliminated our <code>location</code> unit class definition.
Let's create a <code>location</code> unit instance once again:
<pre class="pretop">
<font color="#667f66">  gbbopen-user&gt; <font color="#000000">(make-instance 'location)</font>
  #&lt;location 1&gt;
  gbbopen-user&gt;</font>
</pre>
Note that deleting the blackboard repository also reset the counter for
<code>location</code> instance names, so the created unit instance is again named
<code>1</code>.
</p>
<hr /><address><a target="_top" class="address"
    href="http://GBBopen.org/"><p>The GBBopen Project</a></address><br />
<table width="100%" cellpadding="0" cellspacing="2"><tr>
<td bgcolor="#99ccff"><a href="tutorial-creating-a-space-instance.html"><img border="0" alt="Creating a Space Instance" src="previous.png"/></a></td><td bgcolor="#99ccff"><a href="tutorial_0.html"><img border="0" alt="Top" src="up.png"/></a></td><td bgcolor="#99ccff"><a href="tutorial-development-environment.html"><img border="0" alt="Enhancing Your Development Environment" src="next.png"/></a></td><td align="center" bgcolor="#99ccff" width="100%"><b>Deleting Instances</b></td><td bgcolor="#99ccff"><a target="_top" href="tutorial.html"><img border="0" alt="GoTo Top" src="top.png"/></a></td></tr></table></body></html>
