<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!-- XML file produced from file: tutorial.tex
     using Hyperlatex v 2.9-in-waiting-rk (c) Otfried Cheong -->
<head>
<title>GBBopen 0.9.5 Tutorial -- Application Startup and Event Functions</title>
</p>
<link rel="SHORTCUT ICON" href="favicon.ico"><link rel=stylesheet
        href="gbbopen.css" type="text/css" />
</head>
<body>
<table width="100%" cellpadding="0" cellspacing="2"><tr>
<td bgcolor="#99ccff"><a href="tutorial-control-shell.html"><img border="0" alt="Using a Control Shell" src="previous.png"/></a></td><td bgcolor="#99ccff"><a href="tutorial_0.html"><img border="0" alt="Top" src="up.png"/></a></td><td bgcolor="#99ccff"><a href="tutorial-another-ks.html"><img border="0" alt="Add Another KS" src="next.png"/></a></td><td align="center" bgcolor="#99ccff" width="100%"><b>Application Startup and Event Functions</b></td><td bgcolor="#99ccff"><a target="_top" href="tutorial.html"><img border="0" alt="GoTo Top" src="top.png"/></a></td></tr></table>
<h1>Application Startup and Event Functions</h1>
<p>In the last exercise, we needed to create the <code>known-world</code> space
instance, with <code>x</code> and <code>y</code> dimensions, before we started the
Agenda Shell.  We also needed to call <b>reset-gbbopen</b>,
retaining the unit instances of classes <code>ks</code> and
<code>standard-space-instance</code>, before calling
<b>start-control-shell</b> to execute another run of our developing
application.  It is convenient to have these activities performed
automatically whenever the control shell is started, so we'll do so in
this exercise.
</p>
<p><hr color="99CCCC">
This exercise shows you how to:
</p>
<p><ul class="tight"><li>Define a function to perform all application-specific
initialization and re-execution activities
<li>Automatically invoke the initialization/re-execution function at 
control-shell startup using GBBopen's event-function capabilities
<li>Restrict the classes of unit instances that can be stored on a space 
instance
<li>Specify the dimensionality of a space instance relative to the
dimensional specifications of a unit class
</ul>
</p>
<hr color="99CCCC">
<h2><a name="id1">Prerequisites</a></h2>
<p><ul class="tight"><li>The <code>tutorial-example.lisp</code> file as modified thus far:
</ul>
</p>
<pre>
  (in-package :gbbopen-user)

  (define-unit-class location ()
    (x y)
    (:dimensional-values
      (x :point x)
      (y :point y))
    (:initial-space-instances (known-world)))

  (defmethod print-instance-slots ((location location) stream)
    (call-next-method)
    (when (and (slot-boundp location 'x)
               (slot-boundp location 'y))
      (format stream " (~s ~s)"
              (x-of location)
              (y-of location))))

  ;;; ========================================================================
  ;;;   Startup KS

  (defun startup-ks-function (ksa)
    (declare (ignore ksa))
    ;; Create an initial location unit instance at (0,0):
    (make-instance 'location :x 0 :y 0))

  (define-ks startup-ks
      :trigger-events ((start-control-shell-event))
      :execution-function 'startup-ks-function)
</pre>
<p><ul class="tight"><li>The <code>:agenda-shell-user</code> module is loaded
</ul>
</p>
<h2><a name="id2">Step 1: Define an initialization function</a></h2><p>
Edit your <code>tutorial-example.lisp</code> file and add the following function
definition at the end of the file:
</p>
<pre>
  (defun initializations (event-name &amp;key &amp;allow-other-keys)
    (declare (ignore event-name))
    ;; Clean up any previous run:
    (reset-gbbopen :retain-classes '((ks :plus-subclasses))
                   :retain-event-functions 't
                   :retain-event-printing 't)
    ;; Make a new known-world space instance:
    (make-space-instance 
     '(known-world)
     :dimensions '((x :ordered) (y :ordered))))
</pre>
<p>The first thing to note about the function definition is the argument
signature: <code>initializations</code> is to be invoked with an event name
(which is ignored in our function) and possibly other keyword
arguments (indicated by the <code>&#38;key</code> and <code>&#38;allow-other-keys</code>
lambda list keywords).  This argument signature conforms to GBBopen's
event-function capabilities, which will be introduced in the next step
in this exercise.
</p>
<p>When <code>initializations</code> executes, it resets GBBopen, retaining
only <code>ks</code> unit instances (and instances of any subclasses of
<code>ks</code>), event functions, and the current event printing.  Then it
creates a new <code>(known-world)</code> space instance with ordered
dimensions <code>x</code> and <code>y</code>.  We could have had
<b>reset-gbbopen</b> also retain all space instances, as we did in
the last exercise.  However, I prefer creating all new instances
(other than KSs) over reuse when re-running an application.
</p>
<h2><a name="id3">Step 2: Add an event function</a></h2><p>
GBBopen allows you to attach functions, called <i>event
functions</i>, that are called whenever a specific event is signalled.
Each event function must accept the arguments associated with every
event class to which it is added. In addition, the function should
accept additional arguments that are associated with all subevents of
the specified event classes. This is achieved by specifying
<code>&#38;allow-other-keys</code> in the lambda list of the function.
</p>
<p>Here are GBBopen's defined event classes when the Agenda Shell has
been loaded:
</p>
<br>
<img align="center" src="agenda-shell-events.png">
<br clear="both">
<p>Event classes shown within rectangles are abstract event classes
that cannot be signalled.  Nevertheless, abstract event classes are
very convenient if we wish to attach an event function to an entire
subtree of event classes.  We used abstract event classes to advantage
earlier when we enabled display of all control-shell events by
evaluating:
</p>
<pre><font color="#8c8c8c">  &gt; (enable-event-printing '(control-shell-event :plus-subevents))
  nil
  &gt;
</pre></font>
<p>Add the following form at the end of your <code>tutorial-example.lisp</code> file:
</p>
<pre>
  (add-event-function 'initializations 'start-control-shell-event
                      ;; Initializations should be done first!
                      :priority 100)
</pre>
<p>(We'll place the <b>add-event-function</b> form immediately after the
<code>initializations</code> function definition in our file, but this choice of
location is purely a code organizational style preference&mdash;the form could be
placed anywhere relative to the function definition.)
</p>
<h2><a name="id4">Step 3: Run the application</a></h2><p>
Start a fresh Common Lisp session, compile and load the
<code>tutorial-example.lisp</code> file directly from the editor buffer (using
<code>C-c C-k</code> in SLIME; <code>C-c C-b</code> in ELI) and start the Agenda Shell
again:
</p>
<pre><font color="#8c8c8c">  &gt; <font color="#000000">(start-control-shell)</font>
  ;; Control shell started
  ;; No executable KSAs remain, exiting control shell
  ;; Control shell exited: 3 cycles completed
  ;; Run time: 0 seconds
  ;; Elapsed time: 0 seconds
  :quiescence
  &gt;
</pre></font>
<p>Note that our developing application performs the same as it did in the last
exercise, but now our <code>initializations</code> event function is taking care of
all the details of starting up our application.  We no longer have to remember
to create the <code>known-world</code> space instance or to reset GBBopen before
running the application another time.
</p>
<h2><a name="id5">Step 4: Run it Again</a></h2><p>
Let's verify that we can re-run our application. Without doing anything else,
start the Agenda Shell again:
</p>
<pre><font color="#8c8c8c">  &gt; <font color="#000000">(start-control-shell)</font>
  ;; Control shell started
  ;; No executable KSAs remain, exiting control shell
  ;; Control shell exited: 3 cycles completed
  ;; Run time: 0 seconds
  ;; Elapsed time: 0 seconds
  :quiescence
  &gt;
</pre></font>
<p>As before our <code>initializations</code> event function took care of all the
details of starting up our application.
</p>
</p>
<h2><a name="id6">Step 5: It's a new world<i>...</i></a></h2><p>
GBBopen allows us to restrict the classes of unit instances that can be stored
on a space instance.  For example, we can limit the <code>known-world</code> to
<code>location</code> unit instances by specifying an <code>:allowed-unit-classes</code>
value to <code>make-space-instance</code>:
</p>
<pre><font color="#8c8c8c">  (defun initializations (event-name &amp;key &amp;allow-other-keys)
    (declare (ignore event-name))
    ;; Clean up any previous run:
    (reset-gbbopen :retain-classes '((ks :plus-subclasses))
                   :retain-event-functions 't
                   :retain-event-printing 't)
    ;; Make a new known-world space instance:
    (make-space-instance 
     '(known-world)
     :dimensions '((x :ordered) (y :ordered))
     <font color="#000000">:allowed-unit-classes 'location</font>))
</pre></font>
<p>Attempting to add any unit-instance that is not a <code>location</code> to
<code>known-world</code> will now generate an error.
</p>
<p>It is often convenient to specify the dimensions of a space-instance relative
to those of one or more unit classes.  Edit the definition of
<code>initializations</code>, removing the <code>x</code> and <code>y</code> dimensions
specification:
</p>
<pre><font color="#8c8c8c">  (defun initializations (event-name &amp;key &amp;allow-other-keys)
    (declare (ignore event-name))
    ;; Clean up any previous run:
    (reset-gbbopen :retain-classes '((ks :plus-subclasses))
                   :retain-event-functions 't
                   :retain-event-printing 't)
    ;; Make a new known-world space instance:
    (make-space-instance 
     '(known-world)
     :dimensions <font color="#ff0000">'((x :ordered) (y :ordered))</font>
     :allowed-unit-classes 'location))
</pre></font>
<p>and replacing it with a call of <b>unit-class-dimensions</b> to
obtain the dimensions associated with instances of the <code>location</code>
unit class:
</p>
<pre><font color="#8c8c8c">  (defun initializations (event-name &amp;key &amp;allow-other-keys)
    (declare (ignore event-name))
    ;; Clean up any previous run:
    (reset-gbbopen :retain-classes '((ks :plus-subclasses))
                   :retain-event-functions 't
                   :retain-event-printing 't)
    ;; Make a new known-world space instance:
    (make-space-instance 
     '(known-world)
     :dimensions <font color="#000000">(unit-class-dimensions 'location)</font>
     :allowed-unit-classes 'location))
</pre></font>
<h2><a name="id7">Step 6: Run the application again</a></h2><p>
Compile and load the <code>tutorial-example.lisp</code> file directly from the
editor buffer (using <code>C-c C-k</code> in SLIME; <code>C-c C-b</code> in ELI) and start
the Agenda Shell again:
</p>
<pre><font color="#8c8c8c">  &gt; <font color="#000000">(start-control-shell)</font>
  ;; Control shell started
  ;; No executable KSAs remain, exiting control shell
  ;; Control shell exited: 3 cycles completed
  ;; Run time: 0 seconds
  ;; Elapsed time: 0 seconds
  :quiescence
  &gt;
</pre></font>
<p><a name="id8">Verify</a> the dimensionality of the <code>known-world</code> space instance by evaluating:
</p>
<pre><font color="#8c8c8c">  &gt; <font color="#000000">(describe-space-instance '(known-world))</font>
  Standard-space-instance #&lt;standard-space-instance (known-world)&gt;
    Allowed unit classes: t
    Dimensions:
      (x :ordered)
      (y :ordered)
</pre></font>
<hr /><address><a target="_top" class="address"
    href="http://GBBopen.org/"><p>The GBBopen Project</a></address><br />
<table width="100%" cellpadding="0" cellspacing="2"><tr>
<td bgcolor="#99ccff"><a href="tutorial-control-shell.html"><img border="0" alt="Using a Control Shell" src="previous.png"/></a></td><td bgcolor="#99ccff"><a href="tutorial_0.html"><img border="0" alt="Top" src="up.png"/></a></td><td bgcolor="#99ccff"><a href="tutorial-another-ks.html"><img border="0" alt="Add Another KS" src="next.png"/></a></td><td align="center" bgcolor="#99ccff" width="100%"><b>Application Startup and Event Functions</b></td><td bgcolor="#99ccff"><a target="_top" href="tutorial.html"><img border="0" alt="GoTo Top" src="top.png"/></a></td></tr></table></body></html>
